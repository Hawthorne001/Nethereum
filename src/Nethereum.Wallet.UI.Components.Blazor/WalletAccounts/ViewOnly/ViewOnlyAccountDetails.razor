@using Nethereum.Wallet.WalletAccounts
@using Nethereum.Wallet.UI.Components.WalletAccounts.ViewOnly
@using Nethereum.Wallet.UI.Components.Abstractions
@using Nethereum.Wallet.UI.Components.Core.Localization
@using Nethereum.Wallet.UI.Components.Blazor.Shared
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using System.ComponentModel
@using MudBlazor
@using static Nethereum.Wallet.UI.Components.WalletAccounts.ViewOnly.ViewOnlyAccountDetailsLocalizer
@implements IDisposable
@inject ViewOnlyAccountDetailsViewModel ViewModel
@inject IComponentLocalizer<ViewOnlyAccountDetailsViewModel> Localizer
@inject IJSRuntime JSRuntime

<!-- Using New Reusable Wallet Form Layout for Compact Design -->
<WalletFormLayout Title="@GetTitle()"
                  Subtitle="@GetSubtitle()"
                  ExitText="@Localizer.GetString(Keys.BackToAccounts)"
                  BackText="@Localizer.GetString(Keys.Back)"
                  ContinueText="@Localizer.GetString(Keys.Continue)"
                  PrimaryText="@GetPrimaryActionText()"
                  ShowBack="@(currentSection != ViewSection.Overview)"
                  ShowContinue="false"
                  ShowPrimary="@ShowPrimaryAction()"
                  PrimaryDisabled="@(!CanExecutePrimaryAction())"
                  OnExit="@HandleExit"
                  OnBack="@HandleBack"
                  OnPrimary="@HandlePrimaryAction">
    <ActionButtons>
        @if (currentSection == ViewSection.Overview && ViewModel.Account != null)
        {
            <WalletBarActionButton Icon="@Icons.Material.Filled.Edit"
                                   Text="@Localizer.GetString(Keys.EditAccountName)"
                                   OnClick="@(() => NavigateToSection(ViewSection.EditName))" />
            <WalletBarActionButton Icon="@Icons.Material.Filled.Delete"
                                   Text="@Localizer.GetString(Keys.RemoveAccount)"
                                   Class="wallet-button-danger"
                                   OnClick="@HandleRemoveAccount" />
        }
    </ActionButtons>
    <ChildContent>

    @if (ViewModel.IsLoading)
    {
        <WalletContentSection Class="spacing-normal">
            <div class="loading-state">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                <MudText Typo="Typo.body2" Class="mt-3" Color="Color.Secondary">
                    @Localizer.GetString(Keys.LoadingAccount)
                </MudText>
            </div>
        </WalletContentSection>
    }
    else if (ViewModel.Account != null)
    {
        <!-- Switch between different sections based on currentSection -->
        @switch (currentSection)
        {
            case ViewSection.Overview:
                <!-- Account Overview Section -->
                <WalletContentSection Class="spacing-tight" 
                                    Style="max-width: 500px; margin: 0 auto; margin-top: -1rem;">
                    
                    <div class="account-description">
                        <MudText Typo="Typo.body2" Class="text-center">
                            @string.Format(Localizer.GetString(Keys.AccountDescription), 
                                ViewModel.Account?.Name ?? Localizer.GetString(Keys.UnnamedAccount))
                        </MudText>
                    </div>
                    
                    <WalletAddressDisplay Address="@ViewModel.Account.Address"
                                        ComponentWidth="@ComponentWidth"
                                        IsCompact="@IsCompactMode"
                                        ShowFullAddress="true"
                                        OnCopy="@HandleAddressCopied" />
                    
                    <!-- View-Only Badge -->
                    <div class="text-center mt-4">
                        <MudChip T="string" Size="Size.Medium" Color="Color.Info" Icon="@Icons.Material.Filled.Visibility">
                            @Localizer.GetString(Keys.ViewOnlyBadge)
                        </MudChip>
                    </div>
                    
                    <!-- Integrated Capabilities Info -->
                    <WalletInfoCard Severity="WalletInfoCard.WalletInfoSeverity.Info"
                                    Title="@Localizer.GetString(Keys.ViewOnlyCapabilities)"
                                    Description="@Localizer.GetString(Keys.ViewOnlySecurityNotice)"
                                    Icon="@Icons.Material.Filled.Info" />
                    
                </WalletContentSection>
                break;

            case ViewSection.EditName:
                <!-- Edit Account Name Section -->
                <WalletFormSection Title="@Localizer.GetString(Keys.EditAccountName)">
                    <WalletTextField @bind-Value="ViewModel.EditingAccountName"
                                     LabelKey="@Keys.AccountNameLabel"
                                     PlaceholderKey="@Keys.AccountNamePlaceholder"
                                     HelpKey="@Keys.AccountNameHelperText"
                                     RequiredErrorKey="@Keys.AccountNameRequired"
                                     Loading="@ViewModel.IsLoading"
                                     Required="true"
                                     Localizer="@Localizer" />
                </WalletFormSection>
                break;
        }

        <!-- Success/Error Messages -->
        @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
        {
            <WalletContentSection Class="spacing-normal">
                <WalletInfoCard Severity="WalletInfoCard.WalletInfoSeverity.Error"
                                Title="@Localizer.GetString(Keys.Error)"
                                Description="@ViewModel.ErrorMessage"
                                Icon="@Icons.Material.Filled.Error" />
            </WalletContentSection>
        }

        @if (!string.IsNullOrEmpty(ViewModel.SuccessMessage))
        {
            <WalletContentSection Class="spacing-normal">
                <WalletInfoCard Severity="WalletInfoCard.WalletInfoSeverity.Success"
                                Title="@Localizer.GetString(Keys.Success)"
                                Description="@ViewModel.SuccessMessage"
                                Icon="@Icons.Material.Filled.CheckCircle" />
            </WalletContentSection>
        }
    }
    else
    {
        <!-- Empty state -->
        <WalletContentSection Class="spacing-loose">
            <div class="empty-state">
                <MudIcon Icon="@Icons.Material.Outlined.Visibility" 
                         Size="Size.Large"
                         Color="Color.Secondary" />
                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-3">
                    @Localizer.GetString(Keys.NoAccountSelected)
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @Localizer.GetString(Keys.SelectAccountMessage)
                </MudText>
            </div>
        </WalletContentSection>
    }

    </ChildContent>
</WalletFormLayout>

@code {
    [Parameter] public IWalletAccount? Account { get; set; }
    [Parameter] public bool IsCompactMode { get; set; }
    [Parameter] public int ComponentWidth { get; set; } = 400;
    [Parameter] public EventCallback OnExit { get; set; }
    
    public enum ViewSection
    {
        Overview,
        EditName
    }
    
    private ViewSection currentSection = ViewSection.Overview;

    protected override async Task OnInitializedAsync()
    {
        if (ViewModel is INotifyPropertyChanged notifyPropertyChanged)
        {
            notifyPropertyChanged.PropertyChanged += OnPropertyChanged;
        }

        if (Account != null)
        {
            await ViewModel.InitializeAsync(Account);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Account != null && Account != ViewModel.Account)
        {
            await ViewModel.InitializeAsync(Account);
        }
    }

    private void OnPropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    // Navigation methods
    private void NavigateToSection(ViewSection section)
    {
        currentSection = section;
        StateHasChanged();
    }

    private void HandleBack()
    {
        currentSection = ViewSection.Overview;
        StateHasChanged();
    }

    private async Task HandleExit()
    {
        if (OnExit.HasDelegate)
        {
            await OnExit.InvokeAsync();
        }
    }

    private async Task HandlePrimaryAction()
    {
        switch (currentSection)
        {
            case ViewSection.EditName:
                if (!string.IsNullOrEmpty(ViewModel.EditingAccountName) && ViewModel.SaveAccountNameCommand.CanExecute(null))
                {
                    ViewModel.SaveAccountNameCommand.Execute(null);
                    currentSection = ViewSection.Overview;
                }
                break;
        }
        StateHasChanged();
    }

    // Helper methods for WalletFormLayout
    private string GetTitle()
    {
        return currentSection switch
        {
            ViewSection.Overview => ViewModel.Account?.Name ?? Localizer.GetString(Keys.AccountDetails),
            ViewSection.EditName => Localizer.GetString(Keys.EditAccountName),
            _ => Localizer.GetString(Keys.AccountDetails)
        };
    }

    private string GetSubtitle()
    {
        return currentSection switch
        {
            ViewSection.Overview => Localizer.GetString(Keys.ViewOnlyAccountType),
            ViewSection.EditName => Localizer.GetString(Keys.ChangeAccountName),
            _ => ""
        };
    }

    private string GetPrimaryActionText()
    {
        return currentSection switch
        {
            ViewSection.EditName => Localizer.GetString(Keys.SaveChanges),
            _ => ""
        };
    }

    private bool ShowPrimaryAction()
    {
        return currentSection switch
        {
            ViewSection.EditName => true,
            _ => false
        };
    }

    private bool CanExecutePrimaryAction()
    {
        return currentSection switch
        {
            ViewSection.EditName => !ViewModel.IsLoading,
            _ => false
        };
    }

    private async Task HandleAddressCopied(string address)
    {
        // Copy feedback handled by the component
    }

    private async Task HandleRemoveAccount()
    {
        var success = await ViewModel.RemoveAccountInternalAsync();
        
        // If successful, navigate back to account list
        if (success)
        {
            await OnExit.InvokeAsync();
        }
    }

    public void Dispose()
    {
        if (ViewModel is INotifyPropertyChanged notifyPropertyChanged)
        {
            notifyPropertyChanged.PropertyChanged -= OnPropertyChanged;
        }
    }
}

